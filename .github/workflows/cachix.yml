name: cachix

on:
  schedule:
    - cron: "0 23 * * *"
  workflow_dispatch:

concurrency: cachix

jobs:
  push:
    runs-on: [self-hosted, nix]
    steps:
      - uses: actions/checkout@v6
        with:
          clean: false
      - uses: cachix/cachix-action@v16
        with:
          name: ${{ vars.CACHIX_CACHE_NAME }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          skipAddingSubstituter: true
      - name: Build and push devShell closure
        env:
          CACHE_NAME: ${{ vars.CACHIX_CACHE_NAME }}
        run: |
          nix develop --profile /tmp/solaya-dev-profile -c true
          cachix push "$CACHE_NAME" /tmp/solaya-dev-profile
          rm -f /tmp/solaya-dev-profile
