# Build System

## Cargo Workspace

Root `Cargo.toml` defines workspace:
```
members = ["common", "headers", "kernel", "userspace"]
default-members = ["kernel"]
```

### Workspace Crates

| Crate | Target | Purpose |
|-------|--------|---------|
| kernel | riscv64gc-unknown-none-elf | Main OS kernel (no_std) |
| userspace | riscv64gc-unknown-linux-musl | User programs (musl libc) |
| common | (inherited) | Shared no_std library |
| headers | (inherited) | Linux Header C bindings via bindgen |
| system-tests | x86_64-unknown-linux-gnu | Integration tests (separate workspace) |

### Release Profile
```toml
[profile.release]
panic = 'abort'
lto = "fat"
debug = true              # Debug symbols enabled
overflow-checks = true    # Runtime overflow checks
debug-assertions = true   # Assertions enabled in release
```

## Build Process

### Full Build: `just build`
```
just build
  |
  +-> build-userspace
  |     cd userspace && cargo build --bins
  |     Output: kernel/compiled_userspace/*
  |
  +-> build-cargo
  |     cargo build --release
  |     Output: target/riscv64gc-unknown-none-elf/release/kernel
  |
  +-> patch-symbols
        Extract symbols, embed in kernel binary
        Output: symbols file appended to kernel
```

### Userspace Embedding

Userspace binaries are embedded in the kernel at compile time.

1. `just build-userspace` compiles userspace programs to `kernel/compiled_userspace/`
2. `kernel/build.rs` generates `kernel/src/autogenerated/userspace_programs.rs`
3. Generated file contains `include_bytes!` for each program
4. Programs accessible via `PROGRAMS: &[(&str, &[u8])]` array

**Adding a new userspace program:**
1. Create `userspace/src/bin/myprogram.rs`
2. Run `just build`
3. Program available in shell as `myprogram`

### Symbol Embedding

Debug symbols are extracted and embedded in kernel for backtrace:
```bash
# Extract symbols
riscv64-unknown-linux-musl-nm --demangle --numeric-sort --line-numbers \
    target/riscv64gc-unknown-none-elf/release/kernel | grep -e ' t ' -e ' T ' > symbols

# Embed in binary
riscv64-unknown-linux-musl-objcopy --update-section symbols=./symbols \
    target/riscv64gc-unknown-none-elf/release/kernel
```

## Key Commands

| Command | Description |
|---------|-------------|
| `just build` | Full build (userspace + kernel + symbols) |
| `just build-cargo` | Build kernel only (assumes userspace built) |
| `just build-userspace` | Build userspace programs only |
| `just run` | Build and run in QEMU |
| `just clean` | Remove all build artifacts |
| `just clippy` | Run linter on all crates |
| `just miri` | Run miri for UB detection |

## Directory Output

```
target/
  riscv64gc-unknown-none-elf/
    release/
      kernel              # Final kernel binary

target-userspace/
  riscv64gc-unknown-linux-musl/
    release/
      (userspace binaries)

kernel/compiled_userspace/
  init                    # Copied userspace binaries
  sosh
  prog1
  ...

kernel/src/autogenerated/
  userspace_programs.rs   # Generated include file
```

## Linker Script

`kernel/qemu.ld` - Defines kernel memory layout for QEMU.

## Nix Environment

Development environment provided via `flake.nix`:
- Rust toolchain (nightly, riscv64 target)
- RISC-V cross-compiler toolchain
- QEMU system emulator
- GDB with pwndbg
- cargo-nextest

Automatically entered via direnv.

## Key Files

| File | Purpose |
|------|---------|
| Cargo.toml | Workspace configuration |
| justfile | Build commands |
| kernel/Cargo.toml | Kernel package config |
| kernel/build.rs | Userspace embedding |
| kernel/qemu.ld | Kernel linker script |
| userspace/Cargo.toml | Userspace package config |
| flake.nix | Nix development environment |
